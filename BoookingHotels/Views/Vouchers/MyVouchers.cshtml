@using System.Security.Claims
@model IEnumerable<BoookingHotels.Models.Voucher>

@{
    ViewData["Title"] = ViewData["Title"] ?? "My Vouchers";
    Layout = "~/Views/Shared/_Layout.cshtml";

    var userIdClaim = User.FindFirst(ClaimTypes.NameIdentifier);
    var userId = userIdClaim != null ? int.Parse(userIdClaim.Value) : 0;
}

<style>
    .voucher-card {
        position: relative;
        background: #fff;
        border: 1px solid #dee2e6;
        border-left: 5px solid #0d6efd;
        border-radius: 0.75rem;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        transition: all 0.3s ease;
        overflow: hidden;
        padding: 1.5rem;
    }

        .voucher-card:hover {
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.1);
            transform: translateY(-3px);
        }

    .used-stamp {
        position: absolute;
        top: 20px;
        right: 20px;
        width: 100px;
        height: 100px;
        background-color: transparent;
        color: #dc3545;
        font-weight: 900;
        font-size: 14px;
        text-transform: uppercase;
        border: 3px solid #dc3545;
        border-radius: 50%;
        text-align: center;
        line-height: 100px;
        transform: rotate(-15deg);
        opacity: 0.85;
        z-index: 10;
        box-shadow: 0 0 0 2px rgba(220, 53, 69, 0.25);
        font-family: 'Arial Black', 'Impact', sans-serif;
        letter-spacing: 1px;
        background-image: radial-gradient(circle at center, transparent 50%, rgba(220,53,69,0.1) 95%);
    }


    .voucher-icon {
        font-size: 1.5rem;
        color: #dc3545;
        margin-right: 8px;
    }

    .voucher-footer {
        margin-top: 1rem;
        font-size: 0.875rem;
    }
</style>

<div class="container py-5">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="fw-bold text-primary mb-0">
            <i class="bi bi-ticket-perforated"></i> @ViewData["Title"]
        </h2>
    </div>

    @if (!Model.Any())
    {
        <div class="alert alert-info shadow-sm rounded">
            <i class="bi bi-info-circle"></i> Bạn chưa có voucher nào.
        </div>
    }
    else
    {
        <div class="row g-4">
            @foreach (var v in Model)
            {
                var isUsed = v.UsedVoucherIds?.Any(uv => uv.UserId == userId) == true;

                <div class="col-12">
                    <div class="voucher-card d-flex flex-column flex-md-row justify-content-between align-items-start position-relative">
                        @if (isUsed)
                        {
                            <div class="used-stamp">Đã dùng</div>
                        }

                    <div class="flex-grow-1">
                        <div class="mb-2 d-flex align-items-center">
                            <i class="bi bi-ticket-detailed voucher-icon"></i>
                            <h5 class="fw-bold text-dark mb-0">@v.Code</h5>
                        </div>

                        <p class="text-muted mb-1">@v.Description</p>
                        <p class="mb-1">
                            <b>Loại giảm giá:</b>
                            @(v.DiscountType == "Percent"
                                                    ? $"{v.DiscountValue}%"
                                                    : $"{v.DiscountValue:N0} VND")
                    </p>

                    @if (v.MinOrderValue.HasValue)
                            {
                                <p class="mb-1"><b>Đơn tối thiểu:</b> @v.MinOrderValue.Value.ToString("N0") VND</p>
                            }

                            <p class="mb-1"><b>Hạn sử dụng:</b> @v.ExpiryDate.ToString("dd/MM/yyyy")</p>
                            <p class="mb-1"><b>Số lượng còn:</b> @v.Quantity</p>
                        </div>

                        <div class="voucher-footer text-end mt-3 mt-md-0 ms-md-3">
                            <span class="badge bg-@(v.UserId == null ? "info" : "success") px-3 py-2">
                                @(v.UserId == null ? "Public" : "Của bạn")
                            </span>
                        </div>
                    </div>
                </div>
            }
        </div>
    }
</div>
